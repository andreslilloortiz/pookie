# clang-wrapper.sh

#!/bin/bash
exec o64-clang -fuse-ld=$OSXCROSS_ROOT/target/bin/x86_64-apple-darwin20.2-ld "$@"

# steps

cd sum

python3 -m pip install setuptools wheel build

chmod +x clang-wrapper.sh

export OSXCROSS_ROOT=/osxcross
export CC=$(pwd)/clang-wrapper.sh
export CXX=$CC
export AR=x86_64-apple-darwin20.2-ar
export RANLIB=x86_64-apple-darwin20.2-ranlib
export STRIP=x86_64-apple-darwin20.2-strip
export PYTHON_ROOT=/python-3.10.11-macos11/Python_Framework.pkg/Versions/3.10
export CFLAGS="--target=x86_64-apple-darwin -isysroot $OSXCROSS_ROOT/target/SDK/MacOSX11.1.sdk -I$PYTHON_ROOT/include/python3.10 -I$PYTHON_ROOT/Headers"
export LDFLAGS="-isysroot $OSXCROSS_ROOT/target/SDK/MacOSX11.1.sdk -Wl,-syslibroot,$OSXCROSS_ROOT/target/SDK/MacOSX11.1.sdk -L$PYTHON_ROOT/lib -lpython3.10"

python3 -m build

# compile the library but the EXT_SUFFIX is wrong

# cpython-310-darwin.so

# postbuild
unzip sum-1.0-cp310-cp310-linux_x86_64.whl -d tmp

cd tmp

mv sum.cpython-310-x86_64-linux-gnu.so sum.cpython-310-darwin.so

nano sum-1.0.dist-info/WHEEL (change linux_x86_64 to macosx_10_11_x86_64)

nano sum-1.0.dist-info/RECORD (change x86_64-linux-gnu to darwin)

zip -r ../sum-1.0-cp310-cp310-macosx_10_11_x86_64.whl *

cd ..

rm -f sum-1.0-cp310-cp310-linux_x86_64.whl

rm -rf tmp/